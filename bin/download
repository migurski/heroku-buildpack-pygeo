#!/usr/bin/env python

from sys import argv
from os import environ
from os.path import exists
from subprocess import Popen
from zipfile import ZipFile
from hashlib import md5

try:
    url, build, cache = argv[1:]
except ValueError:
    print 'Usage: %s <url> <build dir> <cache dir>' % argv[0]
    exit(1)

file = '%s/%s.zip' % (cache, md5(url).hexdigest())

if not exists(file):
    curl = Popen(('curl', '-o', file, '-L', url))
    curl.wait()

with ZipFile(file, 'r') as zip:
    for name in zip.namelist():
        if name[-4:] in ('.dbf', '.prj', '.shp', '.shx'):
            with open('%s/datasource.%s' % (build, name[-3:]), 'w') as out:
                print name, '-->', out.name
                out.write(zip.read(name))
